/*****************************************************************************************
 * SCRIPT DE INTEGRAÇÃO DE FOLHA DE PAGAMENTO PARA CONTAS A PAGAR
 * 
 * Objetivo: Importar dados da tabela 'public_folha_pagamento' para o módulo financeiro,
 * criando os títulos em 'Contaapagar' e seus respectivos registros nas tabelas filhas
 * de composição e contabilização, seguindo a lógica de negócio do sistema.
 *
 * Versão: 2.0 - User-Friendly
 *****************************************************************************************/

-- ETAPA 0: LIMPEZA DE TABELAS TEMPORÁRIAS
-- Garante um ambiente limpo, removendo tabelas de execuções anteriores na mesma sessão.
DROP TABLE IF EXISTS Reduzido_Codigo;
DROP TABLE IF EXISTS folha_com_sequencia;


-- ETAPA 1: PREPARAÇÃO DOS DADOS
-- Nenhuma alteração na lógica, apenas preparação das informações em tabelas temporárias.

-- Tabela 1: Calcula o 'codigo_reduzido' correto para cada CPF/CNPJ.
CREATE TEMP TABLE Reduzido_Codigo AS
SELECT 
    pf.cpf,
    pf.tipo_pagamento,
    CASE 
        WHEN pf.tipo_pagamento = '1' THEN CASE WHEN cv.cnpjcpfcodigo IS NOT NULL THEN 905 ELSE 283 END
        WHEN pf.tipo_pagamento = '2' THEN CASE WHEN cv.cnpjcpfcodigo IS NOT NULL THEN 904 ELSE 321 END
        WHEN pf.tipo_pagamento = '3' THEN CASE WHEN cv.cnpjcpfcodigo IS NOT NULL THEN 906 ELSE 1056 END
        WHEN pf.tipo_pagamento = '4' THEN CASE WHEN cv.cnpjcpfcodigo IS NOT NULL THEN 908 ELSE 494 END
        WHEN pf.tipo_pagamento = '5' THEN CASE WHEN cv.cnpjcpfcodigo IS NOT NULL THEN 956 ELSE 955 END
        WHEN pf.tipo_pagamento = '6' THEN 957
        WHEN pf.tipo_pagamento = '7' THEN CASE WHEN pf.cpf IN ('80502237015', '02824237000112', '11156023068') THEN 285 ELSE 905 END
        ELSE NULL 
    END AS codigo_reduzido
FROM public_folha_pagamento pf
LEFT JOIN cadastro_vinculo cv 
    ON cv.cnpjcpfcodigo = pf.cpf
   AND cv.vinculo = '3';

-- Tabela 2: Busca uma nova sequência única para cada registro e junta com os dados da folha.
CREATE TEMP TABLE folha_com_sequencia AS
SELECT  
    pf.*, -- ATENÇÃO: Verifique se sua tabela 'public_folha_pagamento' tem uma coluna com o NOME do favorecido. Chamei de 'nome' mais abaixo.
    seq.sequencia::integer as nova_sequencia
from public_folha_pagamento pf
CROSS JOIN LATERAL avacorpi.fnc_buscar_sequence(
    2, 'contaapagar', 1, 1, 1, 1, NULL, NULL
) AS seq;


-- ETAPA 2: INSERÇÃO NA TABELA PRINCIPAL 'Contaapagar'
-- Insere o título principal com o semáforo inicial em '0' (Pendente) para depois ser alterado via função.
INSERT INTO Contaapagar (
    grupo, empresa, filial, unidade, sequencia, numerotitulo, numeroparcela, 
    valortitulo, valorpendente, valorpago, dtemissaotitulo, dtvencimento, dtprevisaopagamento, 
    cnpjcpfcodigo, reduzido, composicao, moeda, valortitulomoeda, dtinc, dtalt, semaforo, 
    apropriacao, tipotitulo, formapagamento, tipo, posicaocnab, informarmanualmentecontrato, 
    geracreditopiscofins, valorpendentemoeda, codigoformalancamentointerna, codigousuario,
    -- Colunas com valores padrão ou nulos
    dtpagamento, dtcartorio, dtprotesto, valormulta, valorjuro, valordesconto, 
    valordespesacartorio, valordespesaprotesto, observacao, grupodocumentoorigem, empresadocumentoorigem, 
    filialdocumentoorigem, unidadedocumentoorigem, cnpjcpfcodigodocumentoorigem, 
    diferenciadornumerodocumentoorigem, seriedocumentoorigem, numerosequenciadocumentoorigem, 
    dtemissaodocumentoorigem, codigobarra, linhadigitavel, quantidadeparcela, tipopagamento, 
    tipodocumentoorigem, nroremessa, bancocredor, agenciacredor, contacredor, 
    cnpjcpfcodigocredor, vinculocredor, formalancamento, cnpjcpfcodigoadiantamento, 
    proprietario, veiculo, reduzidodebito, moedapagamentooutramoeda, dtcambiopagamentooutramoeda, 
    valorcambiopagamentooutramoeda, valortitulomoedapagamentooutramoeda, codigocobranca, 
    valordespesacartoriomoeda, valormultamoeda, valordespesaprotestomoeda, valorjuromoeda, 
    valordescontomoeda, valorpagomoeda, naturezabasecalculocredito, indicadororigemcredito, 
    cstpis, valorbasecalculopis, percaliquotapis, valorpis, cstcofins, valorbasecalculocofins, 
    percaliquotacofins, valorcofins, codigodareceitadotributo, identificadorfgts, 
    lacreconectividadesocial, digitolagreconectividadesocial, valorreceitabrutaacumulada, 
    percentualsobrereceitabrutaacumulada, valorrecolhimento, outrosvalores, acrescimos, 
    numeroautenticacao, protocoloautenticacao, cnpjcpfcodigosacadoravalista
)
SELECT 
    1 AS grupo,
    1 AS empresa,
    1 AS filial,
    1 AS unidade,
    fcs.nova_sequencia AS sequencia,
    CASE 
        WHEN fcs.tipo_pagamento = '1' THEN 'FOLHA DE PGTO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY')
        WHEN fcs.tipo_pagamento = '2' THEN 'FOLHA DE ADTO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY')
        WHEN fcs.tipo_pagamento = '3' THEN 'FÉRIAS'
        WHEN fcs.tipo_pagamento = '4' THEN 'ADTO 13º SALÁRIO'
        WHEN fcs.tipo_pagamento = '5' THEN 'RESCISÃO'
        WHEN fcs.tipo_pagamento = '6' THEN 'PENSÃO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY')
        WHEN fcs.tipo_pagamento = '7' THEN CASE WHEN fcs.cpf IN ('80502237015', '02824237000112', '11156023068') THEN 'PRO LABORE ' || TO_CHAR(CURRENT_DATE, 'MMYYYY') ELSE 'FOLHA DE PGTO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY') END
        ELSE NULL
    END AS numerotitulo,
    1 AS numeroparcela,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valortitulo,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorpendente,
    0 AS valorpago,
    fcs.data_insercao AS dtemissaotitulo,
    fcs.data_insercao AS dtvencimento,
    fcs.data_insercao AS dtprevisaopagamento,
    CASE WHEN fcs.cpf = '11156023068' THEN '02824237000112' ELSE fcs.cpf END AS cnpjcpfcodigo,
    rc.codigo_reduzido AS reduzido,
    3 AS composicao,  -- Conforme log da inserção manual, o sistema usa '3' (Provavelmente Composição por Rateio).
    1 AS moeda,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valortitulomoeda,
    fcs.data_insercao AS dtinc,
    fcs.data_insercao AS dtalt,
    0 AS semaforo,  -- IMPORTANTE: Inserido como '0' (Pendente/Vermelho). Será alterado para '1' pela função na ETAPA 4.
    2 AS apropriacao, -- '2' para Apropriação Direta.
    4 AS tipotitulo, -- '4' para Outros.
    2 AS formapagamento, -- '2' para Crédito em Conta.
    4 AS tipo, -- '4' para Normal.
    2 AS posicaocnab, -- '2' para Título não enviado em remessa.
    2 AS informarmanualmentecontrato,
    2 AS geracreditopiscofins,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorpendentemoeda,
    -1 AS codigoformalancamentointerna,
    55 AS codigousuario, -- Código do usuário robô/integração.
    -- Demais colunas preenchidas com valores nulos ou padrão para um título simples.
    NULL AS dtpagamento, NULL AS dtcartorio, NULL AS dtprotesto, 0 AS valormulta, 0 AS valorjuro, 0 AS valordesconto, 
    0 AS valordespesacartorio, 0 AS valordespesaprotesto, NULL AS observacao, NULL AS grupodocumentoorigem, NULL AS empresadocumentoorigem, 
    NULL AS filialdocumentoorigem, NULL AS unidadedocumentoorigem, NULL AS cnpjcpfcodigodocumentoorigem, 
    NULL AS diferenciadornumerodocumentoorigem, NULL AS seriedocumentoorigem, nova_sequencia AS numerosequenciadocumentoorigem, 
    NULL AS dtemissaodocumentoorigem, NULL AS codigobarra, NULL AS linhadigitavel, 1 AS quantidadeparcela, NULL AS tipopagamento, 
    0 AS tipodocumentoorigem, NULL AS nroremessa, NULL AS bancocredor, NULL AS agenciacredor, NULL AS contacredor, 
    NULL AS cnpjcpfcodigocredor, NULL AS vinculocredor, NULL AS formalancamento, NULL AS cnpjcpfcodigoadiantamento, 
    NULL AS proprietario, NULL AS veiculo, NULL AS reduzidodebito, NULL AS moedapagamentooutramoeda, NULL AS dtcambiopagamentooutramoeda, 
    0 AS valorcambiopagamentooutramoeda, 0 AS valortitulomoedapagamentooutramoeda, NULL AS codigocobranca, 
    0 AS valordespesacartoriomoeda, 0 AS valormultamoeda, 0 AS valordespesaprotestomoeda, 0 AS valorjuromoeda, 
    0 AS valordescontomoeda, 0 AS valorpagomoeda, NULL AS naturezabasecalculocredito, NULL AS indicadororigemcredito, 
    NULL AS cstpis, 0 AS valorbasecalculopis, 0 AS percaliquotapis, 0 AS valorpis, NULL AS cstcofins, 0 AS valorbasecalculocofins, 
    0 AS percaliquotacofins, 0 AS valorcofins, NULL AS codigodareceitadotributo, NULL AS identificadorfgts, 
    NULL AS lacreconectividadesocial, NULL AS digitolagreconectividadesocial, NULL AS valorreceitabrutaacumulada, 
    0 AS percentualsobrereceitabrutaacumulada, 0 AS valorrecolhimento, 0 AS outrosvalores, 0 AS acrescimos, 
    NULL AS numeroautenticacao, NULL AS protocoloautenticacao, NULL AS cnpjcpfcodigosacadoravalista
FROM folha_com_sequencia fcs
JOIN Reduzido_Codigo rc ON fcs.cpf = rc.cpf
WHERE fcs.cpf IS NOT NULL 
  AND fcs.data_insercao IS NOT NULL 
  AND fcs.deposito IS NOT NULL;


-- ETAPA 3: INSERÇÃO NAS TABELAS FILHAS (COMPOSIÇÃO E CONTABILIZAÇÃO)
-- Esta etapa é crucial para que o título seja considerado válido pelo sistema.

-- ETAPA 3.1: Inserir em 'Contaapagar_composicao'
INSERT INTO Contaapagar_composicao (
    grupo, empresa, filial, unidade, sequencia, sequenciacomposicao, numerosequenciadocumentoorigem,
    tipodocumentoorigem, grupodocumentoorigem, empresadocumentoorigem,
    filialdocumentoorigem, unidadedocumentoorigem, cnpjcpfcodigodocumentoorigem,
    dtemissaodocumentoorigem, dtInc, dtvencimento, dtprevisaopagamento,
    cnpjcpfcodigo, reduzido, valortitulo, numeroparcela, quantidadeparcela, tipotitulo
)
SELECT
    1 AS grupo,
    1 AS empresa,
    1 AS filial,
    1 AS unidade,
    fcs.nova_sequencia AS sequencia,
    1 AS sequenciacomposicao,
    nova_sequencia AS numerosequenciadocumentoorigem,
    2 AS tipodocumentoorigem, -- Conforme log, o tipo de documento na composição é '2'
    1 AS grupodocumentoorigem,
    1 AS empresadocumentoorigem,
    1 AS filialdocumentoorigem,
    1 AS unidadedocumentoorigem,
    CASE WHEN fcs.cpf = '11156023068' THEN '02824237000112' ELSE fcs.cpf END AS cnpjcpfcodigodocumentoorigem,
    fcs.data_insercao AS dtemissaodocumentoorigem,
    fcs.data_insercao AS dtInc,
    fcs.data_insercao AS dtvencimento,
    fcs.data_insercao AS dtprevisaopagamento,
    fcs.cpf AS cnpjcpfcodigo,
    rc.codigo_reduzido AS reduzido,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valortitulo,
    1 AS numeroparcela,
    1 AS quantidadeparcela,
    4 AS tipotitulo
FROM folha_com_sequencia fcs
JOIN Reduzido_Codigo rc ON fcs.cpf = rc.cpf;

-- ETAPA 3.2: Inserir em 'Contaapagar_contabilizacao'
INSERT INTO Contaapagar_contabilizacao (
    grupo, empresa, filial, unidade, sequencia, sequenciacontabilizacao,
    reduzido, valorcredito, valorsaldo, historico, historicodescricao,
    apropriacao, contabilizar, cnpjcpfcodigo
)
SELECT
    1 AS grupo,
    1 AS empresa,
    1 AS filial,
    1 AS unidade,
    fcs.nova_sequencia AS sequencia,
    1 AS sequenciacontabilizacao,
    rc.codigo_reduzido AS reduzido,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorcredito,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorsaldo,
    1 AS historico, -- Código de histórico padrão. Verifique se é sempre 1.
    -- Descrição do histórico gerada dinamicamente, seguindo o padrão do sistema.
    -- ATENÇÃO: Substitua 'fcs.nome' pelo nome da coluna que contém o nome do favorecido.
    'VLR REF. ' || 
    (CASE 
        WHEN fcs.tipo_pagamento = '1' THEN 'FOLHA DE PGTO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY')
        WHEN fcs.tipo_pagamento = '2' THEN 'FOLHA DE ADTO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY')
        WHEN fcs.tipo_pagamento = '3' THEN 'FÉRIAS'
        WHEN fcs.tipo_pagamento = '4' THEN 'ADTO 13º SALÁRIO'
        WHEN fcs.tipo_pagamento = '5' THEN 'RESCISÃO'
        WHEN fcs.tipo_pagamento = '6' THEN 'PENSÃO ' || TO_CHAR(CURRENT_DATE, 'MMYYYY')
        ELSE 'PAGAMENTO'
    END) || '/1 - ' || fcs.nome AS historicodescricao,
    2 AS apropriacao,
    2 AS contabilizar,
    fcs.cpf AS cnpjcpfcodigo
FROM folha_com_sequencia fcs
JOIN Reduzido_Codigo rc ON fcs.cpf = rc.cpf;

-- ETAPA 3.3: Inserir em 'Contaapagar_contabilizacao_filial'
INSERT INTO Contaapagar_contabilizacao_filial (
    grupo, empresa, filial, unidade, sequencia,
    sequenciacontabilizacao, filialcontabilizado,
    valorsaldo, valorcredito
)
SELECT
    1 AS grupo,
    1 AS empresa,
    1 AS filial,
    1 AS unidade,
    fcs.nova_sequencia AS sequencia,
    1 AS sequenciacontabilizacao,
    1 AS filialcontabilizado,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorsaldo,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorcredito
FROM folha_com_sequencia fcs;

-- ETAPA 3.4: Inserir em 'Contaapagar_contabilizacao_filial_unidade'
INSERT INTO Contaapagar_contabilizacao_filial_unidade (
    grupo, empresa, filial, unidade, sequencia,
    sequenciacontabilizacao, filialcontabilizado, unidadecontabilizado,
    valorsaldo, valorcredito
)
SELECT
    1 AS grupo,
    1 AS empresa,
    1 AS filial,
    1 AS unidade,
    fcs.nova_sequencia AS sequencia,
    1 AS sequenciacontabilizacao,
    1 AS filialcontabilizado,
    1 AS unidadecontabilizado,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorsaldo,
    REPLACE(REPLACE(fcs.deposito, '.', ''), ',', '.')::numeric AS valorcredito
FROM folha_com_sequencia fcs;


-- ETAPA 4: ATUALIZAÇÃO DO STATUS (SEMÁFORO) VIA FUNÇÃO DE SISTEMA
-- Esta é a forma correta de alterar o status do título, garantindo que todas as
-- regras de negócio e logs de auditoria do sistema sejam executados.
SELECT Fnc_trocasemaforo_contaapagar(
    1,                          -- Parâmetro: grupo
    1,                          -- Parâmetro: empresa
    1,                          -- Parâmetro: filial
    1,                          -- Parâmetro: unidade
    fcs.nova_sequencia,         -- Parâmetro: sequencia do título a ser alterado
    1,                          -- Parâmetro: novo_status_semaforo (1 = Amarelo/Liberado para Pgto)
    55,                         -- Parâmetro: codigousuario que executa a ação
    1                           -- Parâmetro: [verificar funcionalidade, usado '1' conforme log]
)
FROM folha_com_sequencia fcs;


-- ETAPA 5: LIMPEZA DA TABELA DE ORIGEM
-- Remove os registros da tabela de importação para evitar duplicidade em futuras execuções.
DELETE FROM public_folha_pagamento;